name: Terragrunt Apply on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - master
      - develop
      - release

jobs:
  terragrunt-apply:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Extract Environment from Branch
        id: env
        run: |
          BRANCH="${{ github.event.pull_request.base.ref }}"

          # Map branches to environments
          if [[ "$BRANCH" == "develop" ]]; then
            ENVIRONMENT="dev"
          elif [[ "$BRANCH" == "release" ]]; then
            ENVIRONMENT="qa"
          elif [[ "$BRANCH" == "master" ]]; then
            ENVIRONMENT="prod"
          elif [[ "$BRANCH" == "main" ]]; then
            ENVIRONMENT="dev"
          else
            ENVIRONMENT="dev"
          fi

          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "ðŸ“ Deploying to environment: $ENVIRONMENT"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-2' }}
          role-session-name: GitHubActions-Terragrunt-Apply

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup Terragrunt
        run: |
          wget https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.0/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Detect Changed Terragrunt Files
        id: changes
        run: |
          echo "ðŸ” Detecting changed Terragrunt files in PR #${{ github.event.pull_request.number }}"

          # Get list of changed files in the PR
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path' || echo "")

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Find terragrunt.hcl files
          TERRAGRUNT_FILES=$(echo "$CHANGED_FILES" | grep "terragrunt.hcl$" || echo "")

          if [ -z "$TERRAGRUNT_FILES" ]; then
            echo "âš ï¸ No terragrunt.hcl files found in PR changes"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found terragrunt.hcl files:"
            echo "$TERRAGRUNT_FILES"

            # Extract directory paths (remove /terragrunt.hcl)
            DIRECTORIES=$(echo "$TERRAGRUNT_FILES" | sed 's|/terragrunt.hcl$||' | tr '\n' ',' | sed 's/,$//')

            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "directories=$DIRECTORIES" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Terragrunt Plan and Apply
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          IFS=',' read -ra DIRS <<< "${{ steps.changes.outputs.directories }}"

          for dir in "${DIRS[@]}"; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“ Processing: $dir"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            if [ ! -d "$dir" ]; then
              echo "âš ï¸ Directory $dir does not exist, skipping"
              continue
            fi

            cd "$dir"

            echo ""
            echo "ðŸ”§ Terragrunt Init"
            terragrunt init

            echo ""
            echo "ðŸ“‹ Terragrunt Plan"
            terragrunt plan -out=tfplan

            echo ""
            echo "ðŸš€ Terragrunt Apply"
            terragrunt apply -auto-approve tfplan

            echo ""
            echo "âœ… Successfully applied Terragrunt configuration in $dir"
            echo ""

            cd - > /dev/null
          done

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All Terragrunt configurations applied successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Comment on PR with Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
            const environment = '${{ steps.env.outputs.environment }}';
            const prNumber = ${{ github.event.pull_request.number }};
            const success = '${{ job.status }}' === 'success';

            let body;

            if (!hasChanges) {
              body = '## âš ï¸ No Terragrunt Changes Detected\n\n' +
                     'No `terragrunt.hcl` files were modified in this PR.\n\n' +
                     '**Environment:** `' + environment + '`\n' +
                     '**PR:** #' + prNumber + '\n' +
                     '**Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            } else if (success) {
              const directories = '${{ steps.changes.outputs.directories }}'.split(',');
              const dirList = directories.map(d => '  - `' + d + '`').join('\n');

              body = '## âœ… Terragrunt Apply Successful\n\n' +
                     'Infrastructure has been successfully provisioned!\n\n' +
                     '**Environment:** `' + environment + '`\n' +
                     '**PR:** #' + prNumber + '\n' +
                     '**Applied Configurations:**\n' +
                     dirList + '\n\n' +
                     '**Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n' +
                     '### Next Steps\n' +
                     '- Verify resources in AWS Console\n' +
                     '- Check Backstage portal for updated resource status\n' +
                     '- User will be notified of completion\n';
            } else {
              body = '## âŒ Terragrunt Apply Failed\n\n' +
                     'Infrastructure provisioning encountered errors.\n\n' +
                     '**Environment:** `' + environment + '`\n' +
                     '**PR:** #' + prNumber + '\n' +
                     '**Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n' +
                     'Please check the workflow logs for details.\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Deployment Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## ðŸš€ Terragrunt Deployment Complete

          ### Deployment Details
          - **Environment:** `${{ steps.env.outputs.environment }}`
          - **Branch:** `${{ github.event.pull_request.base.ref }}`
          - **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
          - **Author:** @${{ github.event.pull_request.user.login }}

          ### Applied Configurations
          ```
          ${{ steps.changes.outputs.directories }}
          ```

          ### Status
          âœ… All Terragrunt configurations applied successfully

          ### Links
          - ðŸ”— [PR Details](${{ github.event.pull_request.html_url }})
          - ðŸ”— [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ðŸ”— [AWS Console](https://console.aws.amazon.com/s3/)

          EOF

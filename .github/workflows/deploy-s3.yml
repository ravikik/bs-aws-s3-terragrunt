name: Deploy S3 Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev/prod)'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'
      bucket-name:
        description: 'S3 bucket name (without account ID suffix)'
        required: true
        type: string
        default: 'bs-app'
      enable-versioning:
        description: 'Enable bucket versioning'
        required: true
        type: string
        default: 'true'
      block-public-access:
        description: 'Block all public access'
        required: true
        type: string
        default: 'true'
      enable-lifecycle:
        description: 'Enable lifecycle rules'
        required: true
        type: string
        default: 'true'
      transition-days-ia:
        description: 'Days before transitioning to Infrequent Access'
        required: false
        type: string
        default: '30'
      transition-days-glacier:
        description: 'Days before transitioning to Glacier'
        required: false
        type: string
        default: '90'
      expiration-days:
        description: 'Days before object expiration'
        required: false
        type: string
        default: '365'
      enable-replication:
        description: 'Enable cross-region replication'
        required: false
        type: string
        default: 'false'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'

  push:
    branches:
      - main
      - master
    paths:
      - 'modules/s3/**'
      - 'environments/**'
      - 'terragrunt.hcl'
      - '.github/workflows/deploy-s3.yml'

  pull_request:
    branches:
      - main
      - master
    paths:
      - 'modules/s3/**'
      - 'environments/**'
      - 'terragrunt.hcl'
      - '.github/workflows/deploy-s3.yml'

env:
  AWS_REGION: us-east-2
  TERRAGRUNT_VERSION: 0.55.1
  TERRAFORM_VERSION: 1.7.0

jobs:
  terragrunt:
    name: Terragrunt ${{ github.event.inputs.action || 'plan' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-S3-Deployment

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "action=plan" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "action=plan" >> $GITHUB_OUTPUT
          fi

      - name: Update Terragrunt config (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.bucket-name != ''
        working-directory: environments/${{ steps.env.outputs.environment }}
        run: |
          # Update bucket name if provided
          if [ -n "${{ github.event.inputs.bucket-name }}" ]; then
            sed -i 's/bucket_name = ".*"/bucket_name = "${{ github.event.inputs.bucket-name }}-${{ steps.env.outputs.environment }}-bucket-${get_aws_account_id()}"/' terragrunt.hcl
          fi

          # Update configuration based on inputs
          sed -i 's/enable_versioning = ".*"/enable_versioning = "${{ github.event.inputs.enable-versioning }}"/' terragrunt.hcl
          sed -i 's/block_public_acls = ".*"/block_public_acls = "${{ github.event.inputs.block-public-access }}"/' terragrunt.hcl
          sed -i 's/block_public_policy = ".*"/block_public_policy = "${{ github.event.inputs.block-public-access }}"/' terragrunt.hcl
          sed -i 's/ignore_public_acls = ".*"/ignore_public_acls = "${{ github.event.inputs.block-public-access }}"/' terragrunt.hcl
          sed -i 's/restrict_public_buckets = ".*"/restrict_public_buckets = "${{ github.event.inputs.block-public-access }}"/' terragrunt.hcl
          sed -i 's/enable_lifecycle = ".*"/enable_lifecycle = "${{ github.event.inputs.enable-lifecycle }}"/' terragrunt.hcl
          sed -i 's/transition_days_ia = ".*"/transition_days_ia = "${{ github.event.inputs.transition-days-ia }}"/' terragrunt.hcl
          sed -i 's/transition_days_glacier = ".*"/transition_days_glacier = "${{ github.event.inputs.transition-days-glacier }}"/' terragrunt.hcl
          sed -i 's/expiration_days = ".*"/expiration_days = "${{ github.event.inputs.expiration-days }}"/' terragrunt.hcl
          sed -i 's/enable_replication = ".*"/enable_replication = "${{ github.event.inputs.enable-replication }}"/' terragrunt.hcl

      - name: Terragrunt Init
        working-directory: environments/${{ steps.env.outputs.environment }}
        run: terragrunt init

      - name: Terragrunt Validate
        working-directory: environments/${{ steps.env.outputs.environment }}
        run: terragrunt validate

      - name: Terragrunt Plan
        id: plan
        working-directory: environments/${{ steps.env.outputs.environment }}
        run: |
          terragrunt plan -out=tfplan
          terragrunt show -no-color tfplan > plan.txt
        continue-on-error: true

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('environments/${{ steps.env.outputs.environment }}/plan.txt', 'utf8');
            const output = `#### Terragrunt Plan ðŸ“– - ${{ steps.env.outputs.environment }}

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${plan}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Terragrunt Apply
        if: steps.env.outputs.action == 'apply' && github.event_name == 'workflow_dispatch'
        working-directory: environments/${{ steps.env.outputs.environment }}
        run: terragrunt apply -auto-approve tfplan

      - name: Terragrunt Destroy
        if: steps.env.outputs.action == 'destroy' && github.event_name == 'workflow_dispatch'
        working-directory: environments/${{ steps.env.outputs.environment }}
        run: terragrunt destroy -auto-approve

      - name: Output bucket information
        if: steps.env.outputs.action == 'apply' && github.event_name == 'workflow_dispatch'
        working-directory: environments/${{ steps.env.outputs.environment }}
        run: |
          echo "### S3 Bucket Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Outputs:**" >> $GITHUB_STEP_SUMMARY
          terragrunt output -json | jq -r 'to_entries[] | "- **\(.key):** \(.value.value)"' >> $GITHUB_STEP_SUMMARY
